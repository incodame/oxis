<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Openapi Yaml Analysis</title>
</head>
<body>
    <h1>Openapi Yaml Analysis</h1>
    <div id="greet_answers">
    </div>
<script src="tau-prolog.js"></script>
<script src="js-yaml.js"></script>
<script>
  window.YamlAnalyzer = {};
</script>
<script type="text/prolog" id="code.pl">
:- use_module(library(js)).

init(OpenApi) :-
    %prop('window', Window),
    %prop(Window, 'YamlAnalyzer', YamlAnalyzer),
    %apply(YamlAnalyzer, 'parseYamlExample', [], YamlDoc),
    %prop('console', Console),
    %apply(Console, 'log', [ YamlDoc ], _).
    yaml_prop('/openapi_examples/YamlExample2.yaml', 'openapi', OpenApi).

%
% YAML QUERY
%
yaml_prop_(PathToYaml, Property, Yr, Obj) :-
    ajax('get', PathToYaml, YamlText),
    %DEBUG
    prop('console', Console),
    apply(Console, 'log', [ YamlText ], _),
    prop('window', Window),
    prop(Window, 'YamlAnalyzer', Yr),
    apply(Yr, 'parseYamlResource', [ YamlText ], YamlDoc),
    prop(YamlDoc, Property, Obj).

string_value(Obj, Value) :-
    (atom(Obj) ->
         Value = Obj
    ; Obj \= null ->
      apply(Obj, 'toString', [], Value)
    ; Value = null
    ).

yaml_prop(PathToYaml, Property, Pstr) :-
    yaml_prop_(PathToYaml, Property, _, Obj),
    string_value(Obj, Pstr).

</script>
<script type="module">
import { yamlText } from './modules/YamlExample.js';

window.YamlAnalyzer.parseYamlResource = function(yamlSource) {
    let stripQuotes = function(s) {
        let t=s.length;
        if (s.charAt(0)=='\'') s=s.substring(1,t--);
        if (s.charAt(--t)=='\'') s=s.substring(0,t);
        let newS = s.replace(/\\'/g, "'")
                    .replace(/\\n/g, "\n");
        return newS;
    };
    // Get document, or throw exception on error
    try {
        // variation: safeLoad or load
        const doc = jsyaml.safeLoad(stripQuotes(yamlSource));
        return doc;
    } catch (e) {
        console.log(e);
    }
};

window.YamlAnalyzer.parseYamlExample = function() {
    return window.YamlAnalyzer.parseYamlResource(yamlText());
};

const session = pl.create(1000)
const parsed = session.consult("code.pl")
if (parsed !== true) { console.log(pl.format_answer(parsed)) }
const query = session.query('init(YamlDoc).')
if (query !== true) { console.log(pl.format_answer(query)) }
// session.answer needs a callback function, here we "mute" the output
// session.answer((a) => {}) 
// unmuted: 
session.answer((a) => console.log(pl.format_answer(a)))

//console.log(window.YamlAnalyzer.parseYamlExample());

</script>
</body>
</html>
